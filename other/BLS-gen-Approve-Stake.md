# BLS: генерация ключей, Approve и Stake (опции 18, 19, 20)

Подробное описание работы опций **18** (генерация BLS-ключей и подопции), **19** (Approve) и **20** (Stake) в скрипте aztec-logs для стейкинга валидаторов Aztec.

---

## Опция 18 — Генерация BLS-ключей из мнемоники

В главном меню при выборе **18** открывается подменю **«BLS Keys Generation and Transfer»** с четырьмя способами работы с BLS-ключами.

### Подменю опции 18

| № | Описание                                                                                                           |
|---|--------------------------------------------------------------------------------------------------------------------|
| **1** | Сгенерировать новый адрес оператора                                                                                |
| **2** | Сгенерировать, используя существующие адреса (из мнемоники; только если все адреса валидаторов из одной сид-фразы) |
| **3** | Добавить BLS-ключи в keystore.json                                                                                 |
| **4** | Сгенерировать keystore для дашборда (приватный + staker_output для staking dashboard) - **рекомендуется**          |

---

### Подопция 18-1: Новый адрес оператора

**Назначение:** Замена оператора валидатора: для каждого существующего валидатора генерируется **новый** ETH-адрес и новый BLS-ключ. Старый адрес остаётся в контракте (для вывода и т.п.), а стейкинг привязывается к новому оператору.

**Что делает скрипт:**

1. Запрашивает **старые приватные ключи** валидаторов (один или несколько, через запятую без пробелов; ввод скрыт).
2. По этим ключам вычисляет старые ETH-адреса и сверяет их с `$HOME/aztec/config/keystore.json`.
3. Берёт `feeRecipient` из первого валидатора в keystore.
4. Для **каждого** старого ключа по очереди:
   - Предлагает нажать Enter и запускает `aztec validator-keys new --fee-recipient <feeRecipient>` (без мнемоники — генерируется новая пара ключей).
   - Из сгенерированного `~/.aztec/keystore/key1.json` извлекает новый ETH приватный ключ, BLS приватный ключ и новый ETH-адрес.
   - Связывает старый адрес с новыми ключами и сохраняет в память.
5. Формирует файл **`$HOME/aztec/bls-filtered-pk.json`** в порядке валидаторов из keystore. В каждом элементе есть:
   - `attester.eth` — старый приватный ключ (им подписывается транзакция стейкинга),
   - `attester.bls` — новый BLS приватный ключ,
   - `attester.old_address` — старый адрес,
   - `feeRecipient`,
   - `new_operator_info`: новый ETH приватный ключ, новый BLS, новый ETH-адрес, RPC URL.

**Важно:**  
- Все новые данные (мнемоника при следующем использовании, новые адреса и BLS) нужно **сохранить**. Приватные ключи также попадают в `bls-filtered-pk.json`.  
- Дальнейшие шаги скрипт подсказывает: отправить 0.1–0.3 Sepolia ETH на новый адрес, затем выполнить **опцию 19 (Approve)** и **опцию 20 (Stake)**.

**Когда использовать:** Смена оператора валидатора (новый кошелёк и новые BLS-ключи при сохранении старых адресов в системе).

---

### Подопция 18-2: Существующие адреса (из одной мнемоники)

**Назначение:** Получить BLS-ключи для **уже существующих** ETH-адресов валидаторов, если все эти адреса получены из **одной** мнемонической фразы.

**Что делает скрипт:**

1. Запрашивает **мнемоническую фразу** (ввод скрыт) и **количество кошельков** (например 1, 30, 50 — лучше указать с запасом, лишние будут отброшены).
2. Читает **feeRecipient** из `$HOME/aztec/config/keystore.json` (первый валидатор).
3. Запускает `aztec validator-keys new` с параметрами:
   - `--fee-recipient`, `--mnemonic`, `--count`, `--file bls.json`, `--data-dir $HOME/aztec/`.
4. В сгенерированном `bls.json` для каждого валидатора по приватному ключу вычисляет ETH-адрес (через `cast wallet address`), формирует временный `bls-ethwallet.json`.
5. Берёт список адресов валидаторов из keystore **в том же порядке** и строит **`bls-filtered-pk.json`**: только те пары (приватный ETH + приватный BLS), чьи адреса совпадают с адресами в keystore. Порядок записей совпадает с порядком в keystore.
6. Временные файлы `bls.json` и `bls-ethwallet.json` удаляются.

**Результат:** В `$HOME/aztec/bls-filtered-pk.json` — только ключи, соответствующие валидаторам из keystore. Формат «старый»: нет `new_operator_info`, только `attester.eth`, `attester.bls`, `feeRecipient`. Дальше можно выполнять **опцию 19** и **опцию 20** (старый формат стейкинга).

**Когда использовать:** Все валидаторы из одной сид-фразы, адреса уже есть в keystore — нужно только добавить/обновить BLS-ключи.

---

### Подопция 18-3: Добавить BLS-ключи в keystore.json

**Назначение:** Вписать BLS приватные ключи из `bls-filtered-pk.json` в `$HOME/aztec/config/keystore.json` (в поле `attester.bls` для каждого валидатора по совпадению ETH-адреса).

**Что делает скрипт:**

1. Проверяет наличие `$HOME/aztec/bls-filtered-pk.json` и `$HOME/aztec/config/keystore.json`.
2. Создаёт резервную копию keystore с меткой времени.
3. Строит соответствие: ETH-адрес (из приватного ключа в bls-filtered-pk) → BLS приватный ключ.
4. Для каждого валидатора в keystore по полю `attester.eth` (адрес) подставляет соответствующий BLS из bls-filtered-pk и обновляет `attester.bls`.
5. Сохраняет обновлённый keystore и выводит краткий отчёт.

**Когда использовать:** Только после генерации BLS (подопция 18-1 или 18-2) и только если BLS получены из сид-фразы или вы сами корректно собрали `bls-filtered-pk.json`. Не применяйте к случайным файлам.

---

### Подопция 18-4: Keystore для дашборда (рекомендуется)

**Назначение:** Создать файлы для **staking dashboard** (документация Aztec: sequencer_management и т.п.): приватный keystore и staker_output.

**Что делает скрипт:**

1. Использует каталог `$HOME/aztec`, адрес GSE из настроек сети (mainnet/testnet), RPC из настроек скрипта (или дефолтный Sepolia).
2. Спрашивает: новая мнемоника **(1)** или ввод своей **(2)**.
3. Запрашивает количество идентичностей валидаторов (например 1 или 5).
4. Запускает `aztec validator-keys new` с флагами:
   - `--fee-recipient` (нулевой адрес),
   - `--staker-output`,
   - `--gse-address`, `--l1-rpc-urls`, `--data-dir $HOME/aztec`,
   - `--file dashboard_keystore.json`,
   - при выборе 2 — `--mnemonic "..."`,
   - `--count N`.
5. Результат сохраняется в `$HOME/aztec/`:
   - **dashboard_keystore.json** — приватный keystore,
   - **dashboard_keystore_staker_output.json** — для дашборда стейкинга.

**Когда использовать:** Подготовка ключей именно для веб-дашборда стейкинга Aztec, а не для работы опций 19/20 в этом скрипте.

---

## Опция 19 — Approve

**Назначение:** Разрешить смарт-контракту стейкинга (rollup) тратить ваш стейкинг-токен (approve на сумму до 200000 ether в единицах токена). Без этого шага опция 20 (Stake) не сможет списать токен с вашего кошелька.

**Что делает скрипт:**

1. Берёт сеть, RPC и адрес контракта из настроек скрипта (`get_network_settings`).
2. Ищет все файлы `*.yml` в `$HOME/aztec/keys/` (сортировка по имени, например validator_1, validator_2). Файлы с «bls» в имени пропускаются.
3. Из каждого YML извлекает `privateKey:` (значение в кавычках).
4. Для каждого ключа:
   - Вычисляет ETH-адрес и запрашивает **nonce** (pending), чтобы не дублировать nonce при нескольких подряд идущих транзакциях.
   - Gas: 50% выше текущего gas price, минимум 10 gwei; при ошибке «replacement transaction underpriced» повтор с удвоенным gas и следующим RPC.
   - Вызывает **ERC-20 approve**: контракт токена `0x5595cb9ed193cac2c0bc5393313bc6115817954b`, метод `approve(address,uint256)` — в качестве spender передаётся адрес контракта стейкинга (rollup), сумма `200000 ether` (в wei токена).
   - Используется список RPC (основной + запасные Sepolia), для разных валидаторов — разные RPC по кругу, между транзакциями пауза ~12 секунд.

**Важно:**  
- В `$HOME/aztec/keys/` должны лежать YML-файлы с приватными ключами тех кошельков, с которых вы будете стейкать.  
- Если транзакция «висит» (pending), скрипт подсказывает отменить или ускорить её (например через MetaMask), затем снова запустить Approve.

**Порядок:** Approve (19) выполняется **после** генерации BLS (18) и **до** Stake (20). Для метода «новый оператор» (18-1) перед 19 нужно пополнить новые адреса ETH для газа.

---

## Опция 20 — Stake

**Назначение:** Зарегистрировать валидатора в сети (вызвать контракт стейкинга): привязать BLS-ключ и данные валидатора к rollup-контракту. Используются данные из `bls-filtered-pk.json` и при необходимости из `keystore.json`.

**Что делает скрипт:**

1. Проверяет наличие `$HOME/aztec/bls-filtered-pk.json`. Если файла нет — предлагает сначала выполнить опцию 18.
2. Определяет формат bls-filtered-pk:
   - если у первого валидатора есть поле **`new_operator_info`** — считается **новый формат** (метод нового оператора, 18-1);
   - иначе — **старый формат** (существующие адреса, 18-2).
3. Сеть, RPC и адрес контракта rollup берутся из настроек скрипта.

Дальше поведение различается.

---

### Stake — старый формат (existing method)

- Для каждого валидатора из `bls-filtered-pk.json`:
  - Приватный ключ ETH и BLS берутся из `bls-filtered-pk.json` (поля `attester.eth`, `attester.bls`).
  - ETH-адрес attester берётся из **keystore.json** по тому же индексу (порядок должен совпадать).
- Команда для каждого валидатора:
  - `aztec add-l1-validator`
  - `--l1-rpc-urls`, `--network`, `--private-key` (из bls-filtered-pk),
  - `--attester`, `--withdrawer` (адрес из keystore),
  - `--bls-secret-key` (из bls-filtered-pk),
  - `--rollup` (адрес контракта).
- Скрипт перебирает несколько RPC при ошибке; перед отправкой запрашивает подтверждение (y/s/q). После успеха выводит ссылку на валидатора (например dashtec.xyz).

---

### Stake — новый формат (new operator method)

- Для каждого валидатора из `bls-filtered-pk.json`:
  - Старый приватный ключ — `attester.eth` (им подписывается транзакция).
  - Новый адрес и ключи — из `new_operator_info`: `eth_private_key`, `bls_private_key`, `eth_address`, при необходимости `rpc_url`.
- Команда формируется так же, но в качестве attester/withdrawer используется **новый** адрес из `new_operator_info`.
- После успешного стейка:
  - В `$HOME/aztec/keys/` создаётся YML с **новым** приватным ключом (для последующих Approve и т.д.).
  - В **keystore.json** старый адрес валидатора заменяется на новый (чтобы конфигурация ноды соответствовала новому оператору).
  - Предлагается перезапуск **web3signer** для подхвата нового ключа.

Ссылки на валидатора (mainnet/testnet) выводятся так же, как в старом формате.

---

## Краткая последовательность шагов

1. **Опция 18** — выбрать подходящий способ (1: новый оператор, 2: существующие адреса из мнемоники, 3: добавление BLS в keystore, 4: дашборд).
2. Для **18-1**: пополнить новые адреса на 0.1–0.3 Sepolia ETH.
3. **Опция 19** — Approve для всех ключей из `$HOME/aztec/keys/*.yml` (кроме bls).
4. **Опция 20** — Stake по данным из `bls-filtered-pk.json` (формат определяется автоматически).

После успешного Stake валидаторы отображаются в эксплорере (например dashtec.xyz), нода может использовать обновлённый keystore и ключи из `keys/`.
