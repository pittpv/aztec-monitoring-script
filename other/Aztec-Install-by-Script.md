# Установка ноды Aztec с помощью скрипта от pittpv

Данное руководство поможет вам быстро и легко развернуть ноду Aztec с помощью удобного скрипта мониторинга и управления от **pittpv**. Скрипт автоматизирует большую часть рутинных задач, минимизируя риск ошибок.

## Запуск скрипта

Для первоначального запуска скрипта выполните в терминале однострочную команду:

```bash
curl -o aztec-logs.sh https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/aztec-logs.sh && chmod +x aztec-logs.sh && ./aztec-logs.sh
```

> **Важно:** Для всех последующих запусков используйте команду:
> ```bash
> cd $HOME && ./aztec-logs.sh
> ```

## Начальная настройка

После запуска скрипт проверит наличие необходимого системного ПО (такого как `docker`, `docker-compose`, `jq` и др.) и предложит его установить. **Согласитесь на установку**, ответив `y` (yes).

В главном меню скрипта вам будет представлен список опций. Для начала установки ноды:

1.  **Выберите пункт `11` основного меню и нажмите Enter.**

    ![Главное меню скрипта](https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/other/Aztec-Install-by-Script/1.jpg)

## Проверка портов и установка зависимостей

Скрипт автоматически проверит, заняты ли порты, необходимые для работы ноды (например 40400, 8080). Если порты заняты, он предложит назначить другие, но **рекомендуется использовать стандартные порты**, если это возможно.

Далее будет проверено наличие ПО, специфичного для ноды Aztec, и снова предложена установка. **Согласитесь на установку**.

> **Примечание:** Если на вашем сервере активирован фаерволл `ufw`, скрипт автоматически откроет все необходимые порты.

## Установка бинарных файлов и Docker-образа

На этом этапе скрипт запустит скачивание и установку компонентов ноды с помощью оригинального скрипта от команды Aztec.

**Внимание! Если появится вопрос:**
```
Add it to /root/.bash_profile to make the aztec binaries accessible?
```

**Введите `n` (no).** Только для вопроса, который указан выше. Будьте внимательны.

![Вопрос о добавлении в .bash_profile](https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/other/Aztec-Install-by-Script/2.jpg)

## Настройка валидаторов

Следующие вопросы:
```
Вы хотите запустить несколько валидаторов? (y/n)

У вас есть BLS ключи? (y/n)
```

*   Если вы запускаете **одного валидатора**, введите `n`.
*   Если планируете запускать **несколько валидаторов**, введите `y`.

    ![Выбор количества валидаторов](https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/other/Aztec-Install-by-Script/3.jpg)

### Для режима мультивалидатора

Далее необходимо ввести данные валидаторов. Для каждого валидатора введите данные в строгом формате:

`приватный_ключ_с_0x,адрес_валидатора`

Пример:
`0xa1b2c3d4e5f6...,0x742d35Cc6634C0532925a3b844Bc454e4438f44e`

Если выбран вариант с BLS ключами, то в строгом формате:

`приватный_ключ_с_0x,адрес_валидатора,приватный_BLS_ключ_с_0x,публичный_BLS_адрес`

Пример:
`0xa1b2c3d4e5f6...,0x742d35Cc6634C0532925a3b844Bc454e4438f44e,0xa1b2c3d4e5f6...,0x12d4720c311e6d2e0826738a071fa06743f6cb8efd586ed718c3b020f09b5c8d`

⚠️ Если вы планируете использовать **один адрес** для списывания sepolia eth за транзакции **всех** валидаторов, тогда внесите данные этого адреса первыми. После ввода данных всех валидаторв скрипт уточнит, надо ли использовать первый адрес как publisher-адрес для всех валидаторов (`Use first address as publisher for all validators?`) - выберите **`y`**.

Если же sepolia eth есть на всех адресах, то можно выбрать **`n`** 

![Ввод данных валидатора](https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/other/Aztec-Install-by-Script/4.jpg)

### Для режима одного валидатора

Введите по отдельности приватный ключ и eth адрес валидатора.

### Aztec L2 адрес для feeRecipient

После этого скрипт запросит **Aztec L2 адрес**, который вы можете создать на сайте: https://app.obsidion.xyz/ или в расширении https://azguardwallet.io/.

Если по каким-то причинам вы не можете создать Aztec L2 адрес, то вставьте `0x0000000000000000000000000000000000000000000000000000000000000000` 

При желании потом сможете заменить на реальный L2 адрес.

![Ввод L2 адреса](https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/other/Aztec-Install-by-Script/5.jpg)

> **Важно:** Скрипт автоматически создаст все необходимые конфигурационные файлы (`YML` для web3signer в `/root/aztec/keys` и `keystore.json` в `/root/aztec/config`).

## Конфигурация Docker Compose

Для финальной настройки ноды скрипт запросит у вас данные для генерации файла `docker-compose.yml`:

*   **`ETHEREUM_RPC_URL`** — ваш RPC-адрес для Ethereum L1. **Важно:** Для mainnet используйте mainnet RPC, для testnet — Sepolia testnet RPC.
*   **`CONSENSUS_BEACON_URL`** — ваш RPC-адрес для Beacon Chain. **Важно:** Для mainnet используйте mainnet Beacon Chain RPC, для testnet — Sepolia testnet Beacon Chain RPC.
*   **`COINBASE`** — адрес eth кошелька. Введите адрес вашего валидатора.
*   **`P2P_IP`** — этот параметр скрипт определит автоматически. **Если вы используете VPN на сервере**, то после завершения установки ноды необходимо ввести реальный ip-адрес **вручную** в файле `.env` в папке `/root/aztec`

    ![Ввод RPC и других данных](https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/other/Aztec-Install-by-Script/6.jpg)

## Выбор сети (Mainnet/Testnet)

После ввода RPC-адресов скрипт предложит выбрать сеть для работы ноды:

1.  **Mainnet** — основная сеть Aztec
2.  **Testnet** — тестовая сеть Aztec

Выберите нужную сеть, введя соответствующую цифру (1 или 2).

> **Важно:** 
> *   Выбранная сеть определяет, в какой сети будет работать ваша нода
> *   Данные ноды будут храниться в разных директориях: `/root/.aztec/mainnet/data/` для mainnet и `/root/.aztec/testnet/data/` для testnet
> *   Убедитесь, что используете правильные RPC-адреса для выбранной сети
> *   Выбранная сеть сохраняется в файле `~/.env-aztec-agent` в переменной `NETWORK`

## Установка Watchtower

Скрипт предложит установить **Watchtower** — сервис для автоматического обновления контейнеров вашей ноды. Для настройки уведомлений в Telegram о процессе обновления потребуется:

1.  **Telegram Token:** Получите у [BotFather](https://t.me/BotFather), создав нового бота.
2.  Обязательно **зайдите в своего созданного бота** и отправьте в чат команду `/start`.
3.  **Chat ID:** Узнайте свой ID чата, например, с помощью бота [@myidbot](https://t.me/myidbot).

Введите запрошенные данные при появлении соответствующих запросов.

![Ввод данных для Telegram-уведомлений](https://raw.githubusercontent.com/pittpv/aztec-monitoring-script/main/other/Aztec-Install-by-Script/7.jpg)

## Установка web3signer

Скрипт автоматически скачает образ web3signer и запустит с нужными аргурментами. 

## Завершение установки и проверка

После завершения всех шагов скрипт сообщит об успешной установке и автоматически запустит показ логов (`docker-compose logs -f`).

**Дождитесь появления логов и убедитесь, что нода начала синхронизацию.** Для выхода из режима просмотра логов нажмите сочетание клавиш **`Ctrl+C`**.

На этом установка ноды завершена.

## Дальнейшие действия

1.  **Проверьте статус синхронизации** ноды, выбрав опцию `1` в главном меню скрипта.
2.  **Установите агент мониторинга** для удобного отслеживания работы ноды через опцию `2` в главном меню.
3.  **Скачайте файл определения критических ошибок** с помощью опции `24`
4.  **Проверьте статус валидатора и установите мониторинг позиции в очереди** с помощью опции `9` 

Обязательно изучите другие возможности скрипта в главном меню, такие как:
*   Запуск и остановка контейнеров
*   Даунгрейд версии ноды (на случай проблем с обновлением)
*   Просмотр логов и статистики

## Повторная установка ноды и добавление BLS ключей (опция 18)

При повторной установке ноды (опция 11) и при последующем добавлении BLS ключей важно понимать два варианта установки и то, как с ними работают подопции опции **18** (Генерация BLS ключей).

### Установка ноды: с BLS или без

- **С BLS ключами** — при установке (опция 11) на вопрос «У вас есть BLS ключи?» ответьте **`y`** и введите для каждого валидатора данные в формате:  
  `приватный_ключ,адрес,приватный_BLS,публичный_BLS`.  
  Скрипт сразу создаст `keystore.json` и YML-файлы с BLS. Дополнительные шаги по BLS не нужны.

- **Без BLS ключей** — ответьте **`n`**. Скрипт создаст `keystore.json` только с eth-адресами валидаторов (без поля `bls`). BLS ключи можно добавить позже через опцию 18, как описано ниже.

### Внутренний файл скрипта

Файл **`bls-filtered-pk.json`** создаётся и используется **только скриптом**. Его не нужно редактировать вручную ни при каких обстоятельствах — файл создаётся и используется только скриптом. Путь: `$HOME/aztec/bls-filtered-pk.json`.

---

### Вариант A: BLS из той же мнемоники, что и адреса в keystore (опции 18-2 и 18-3)

Подходит, если при установке ноды вы указали валидатора по eth-адресу, полученному из вашей мнемоники, и теперь хотите получить для него BLS ключи из той же мнемоники.

1. **Опция 18 → подопция 2** (существующие адреса из мнемоники).
2. Введите мнемоническую фразу и **количество кошельков** для генерации (например, 30 или 50). Скрипт сгенерирует ключи для этого количества индексов, затем оставит только те, чей eth-адрес совпадает с адресами в `keystore.json`.  
   Итог: создаётся **`bls-filtered-pk.json`** с ключами именно для тех адресов, которые вы добавили как валидаторов при установке ноды.
3. Если нода была установлена **без BLS**, выполните **опция 18 → подопция 3** (добавить BLS ключи в keystore). Скрипт перенесёт BLS из `bls-filtered-pk.json` в `keystore.json`.
4. Дальше два пути:
    - **Вариант 1:** выполните **опции 19 (Approve)** и **20 (Stake)** для стейкинга валидатора.
    - **Вариант 2 (ключ для дашборда):** выполните **опция 18 → подопция 4** (dashboard keystores). Укажите **то же количество адресов**, что и в шаге 2 (например, 30). Скрипт создаст файлы нового формата со всеми сгенерированными адресами. Откройте созданный файл, **вручную удалите лишние записи** и оставьте только ту, которая соответствует нужному вам валидатору.

---

### Вариант B: Новый адрес оператора (опция 18-1)

Подходит, если вы хотите завести **новый** eth-адрес и BLS ключи (например, для перехода на новый кошелёк).

1. **Опция 18 → подопция 1** (новый адрес оператора).
2. Введите старый приватный ключ (или ключи через запятую). Скрипт сгенерирует новые ключи и создаст **`bls-filtered-pk.json`** с полем `new_operator_info` для каждого валидатора.
3. Пополните новый eth-адрес Sepolia ETH (0.1–0.3), затем выполните **опции 19 (Approve)** и **20 (Stake)**. Опция 20 при успешном стейке **сама обновит `keystore.json`**, подставив новый адрес оператора вместо старого, и создаст YML-файлы с новыми ключами.
4. Опция **18-3** в этом сценарии не используется — подстановка адресов в keystore делается в опции 20.

---

### Вариант C: Только ключи для дашборда (опция 18-4)

Если нужны **только** keystore для staking dashboard (docs.aztec.network), без изменения конфигурации ноды:

- **Опция 18 → подопция 4.** Выберите новую мнемонику (1) или введите существующую (2), укажите количество идентичностей валидаторов. Скрипт создаст в `$HOME/aztec/` файлы **`dashboard_keystore.json`** и **`dashboard_keystore_staker_output.json`**. В `keystore.json` ноды и в `bls-filtered-pk.json` ничего не меняется.

Если указано **больше одной** идентичности валидатора, в созданных файлах будут данные по **всем** сгенерированным адресам. Оставьте в файле только нужные записи: откройте файл и **вручную удалите лишние**, чтобы использовать в дашборде только один (или нужное вам подмножество) адресов.

---

### Краткая сводка по подопциям 18

| Подопция | Назначение | Меняет ли `keystore.json`? |
|----------|------------|----------------------------|
| **18-1** | Новый адрес оператора; потом 19 и 20 (20 сама обновит keystore) | Нет напрямую; обновление в опции 20 |
| **18-2** | BLS из мнемоники для адресов, уже указанных в keystore при установке | Нет; создаёт только `bls-filtered-pk.json` |
| **18-3** | Перенести BLS из `bls-filtered-pk.json` в `keystore.json` | Да |
| **18-4** | Keystore для дашборда (отдельные файлы в `$HOME/aztec/`) | Нет |

Желаем стабильной работы и успеха в запуске ноды!

С уважением,
pittpv

> **Если у вас возникли вопросы по работе скрипта**, задавайте их в нашем Telegram-чате: [https://t.me/+DLsyG6ol3SFjM2Vk](https://t.me/+DLsyG6ol3SFjM2Vk)
